<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // Check local storage immediately
        const currentTheme = localStorage.getItem('theme');
        // If dark, add class to HTML tag (not body) before content loads
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} | {{ .Site.Title }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ "css/hankel.css" | relURL }}">
    {{ with .Site.Params.favicon }}
    <link rel="icon" href="{{ . | relURL }}" type="image/x-icon">
    {{ end }}

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <div class="container-x">
        <nav class="nav-x">
            <div class="nav-links">
                {{ range .Site.Menus.main.ByWeight }}
                    <a href="{{ .URL }}">{{ .Name }}</a>
                {{ end }}
            </div>

            <button id="theme-toggle" aria-label="Toggle Dark Mode">Theme</button>
        </nav>

        <main>
            {{ block "main" . }}{{ end }}
        </main>

        <footer>
            &copy; {{ now.Year }} {{ .Site.Params.authorName }}
        </footer>
    </div>

    <script>
        // 1. WIKILINK LOGIC
        document.addEventListener("DOMContentLoaded", function() {
            const article = document.querySelector('article');
            if (article) {
                article.innerHTML = article.innerHTML.replace(
                    /\[\[(.*?)\]\]/g, 
                    function(match, text) {
                        const slug = text.trim().toLowerCase().replace(/\s+/g, '-');
                        return `<a href="/posts/${slug}" class="wikilink">${text}</a>`;
                    }
                );
            }
        });

        // 2. TOGGLE BUTTON LOGIC
        const toggleBtn = document.getElementById('theme-toggle');
        const htmlTag = document.documentElement;

        // Set initial button text based on current state
        if (htmlTag.classList.contains('dark-mode')) {
            toggleBtn.innerText = "Light Mode";
        } else {
            toggleBtn.innerText = "Dark Mode";
        }

        toggleBtn.addEventListener('click', () => {
            htmlTag.classList.toggle('dark-mode');
            
            if (htmlTag.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                toggleBtn.innerText = "Light Mode";
            } else {
                localStorage.setItem('theme', 'light');
                toggleBtn.innerText = "Dark Mode";
            }
        });
    </script>
</body>
</html>
